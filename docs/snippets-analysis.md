# Анализ: snippets.json, save_1c_snippet и загрузка из папки

## 1. Нужен ли snippets.json при наличии save_1c_snippet?

**Да, оба нужны — у них разные роли.**

| Аспект | snippets.json | save_1c_snippet |
|--------|---------------|-----------------|
| **Источник** | Кураторский набор в репо | Агент сохраняет во время сессии |
| **Жизненный цикл** | Версионируется, один для всех | Накопление в Qdrant, зависит от деплоя |
| **Когда полезен** | Базовый набор, новый деплой, сброс памяти | Уточнение и обогащение по ходу работы |
| **Формат** | JSON с title, description, code_snippet | code_snippet + description (через MCP) |

snippets.json — стартовый набор шаблонов. save_1c_snippet — дополнение в рантайме. Они дополняют друг друга.

---

## 2. Почему агент не использовал save_1c_snippet

**Причины:**

1. **Нет явной инструкции** — в AGENTS.md и правилах не указано: «когда даёшь рабочий код 1С, сохраняй его через save_1c_snippet».
2. **Фокус на ответе** — цель была ответить на вопрос, а не обогащать память.
3. **Недостаточная сигнатура** — save_1c_snippet принимает только `code_snippet` и `description`. Нет `title`, который улучшает поиск в памяти.
4. **Слабый summary** — при сохранении `_format_long_summary` строит текст из title/query/topic_path; у save_snippet они пусты → embedding почти неинформативен.

**Что поменять:**
- Добавить правило в AGENTS.md: сохранять рабочий код через save_1c_snippet.
- Добавить необязательный параметр `title` в save_1c_snippet.
- Улучшить `_format_long_summary` для save_snippet (использовать description и начало code_snippet).

---

## 3. Загрузка сниппетов из папки

**Задача:** добавлять шаблоны, положив файлы в папку (как справка через .hbk/ingest).

**Схема:**
- `SNIPPETS_DIR` — каталог со сниппетами (по умолчанию `docs/snippets/`).
- `load-snippets` читает:
  1. `snippets.json` (если есть) — как раньше;
  2. Файлы из папки — `.bsl`, `.1c`, `.md` с блоками кода.
- Формат файлов:
  - `*.bsl`, `*.1c` — код в файле, title = имя файла, description = пусто или из соседнего `.meta.json`;
  - `*.md` — YAML frontmatter (title, description) + блок ```bsl;
  - Поддержка подпапок для группировки.

**Результат:** сниппеты можно добавлять, просто добавляя файлы в папку, без правок JSON.

---

## 4. Реализованные изменения

- **AGENTS.md:** добавлено правило — сохранять рабочий код 1С через `save_1c_snippet`.
- **save_1c_snippet:** добавлен необязательный параметр `title` для улучшения поиска.
- **_format_long_summary:** для save_snippet при пустых title/query используется `description` + `code_snippet`.
- **load-snippets:** поддержка папки — `SNIPPETS_DIR`, аргумент может быть путём к папке. Сканируются `*.bsl`, `*.1c`, `*.md` (YAML frontmatter + блок кода). Сначала загружается `snippets.json` (если есть), затем файлы из папки (могут переопределять по title).

## 5. Разделение примеров и реальных сниппетов

- **docs/snippets/** — только примеры (не загружаются автоматически).
- **Реальные сниппеты** — только из смонтированного тома (read-only): `SNIPPETS_DIR`, volume в docker-compose/docker run.
- **docker-compose:** `./snippets:/data/snippets`, при старте — `load-snippets`, если `SNIPPETS_DIR` задан и каталог существует.

---

## 6. Embedding vs поиск по тексту для сниппетов

**Текущая схема:** сниппеты из `load-snippets` попадают в `onec_help_memory` (Qdrant) **с эмбеддингами** и domain="snippets". `get_1c_code_answer` при `include_memory=True` делает семантический поиск `search_long(query)` — ищет по векторному сходству.

**Стоит ли оставить embedding или достаточно keyword search?**

| Критерий | Embedding (сейчас) | Только keyword search |
|----------|--------------------|------------------------|
| Запрос «как преобразовать таблицу в массив» | Находит «ТаблицаЗначенийВМассив» по смыслу | Нужно точное совпадение слов |
| Запрос «Формат числа» | Находит сниппет с Формат(Число,…) | Находит при точном совпадении |
| Запрос «ЗаполнитьЗначенияСвойств» | Найдёт примеры с этой функцией | Найдёт при вхождении в текст |
| Стоимость | API эмбеддингов при load-snippets (разово) | Нет |
| Хранилище | Qdrant, векторы | Нужен отдельный индекс или линейный поиск |

**Рекомендация: оставить embedding.** Причины:
1. Пользователи часто спрашивают задачей («как сделать X»), а не именем функции.
2. Summary = title + description + code[:300] даёт осмысленный вектор для семантического поиска.
3. Инфраструктура уже есть — load-snippets делает upsert в long memory.
4. Keyword search отдельно не реализован для сниппетов; для справки есть `search_1c_help_keyword` по индексу help.

**Опционально:** добавить keyword-индекс по именам функций/процедур из кода (regex) как дополнительный путь поиска — но это усложнит архитектуру. Пока embedding достаточно.

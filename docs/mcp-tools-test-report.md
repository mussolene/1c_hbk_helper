# Отчёт тестирования MCP-инструментов 1C-help

**Дата:** 2025-02-26  
**Запросы:** (1) «вывод СКД в таблицу значений», (2) «создать и вывести отчет в табличный документ программно»  
**Ожидаемый ответ:** конечный код, исполняемый в 1С без ошибок

---

## 1. Результаты вызовов инструментов

| Инструмент | Статус | Комментарий |
|------------|--------|-------------|
| **get_1c_code_answer** | ⚠️ Нестабильно | Для запроса «табличный документ» возвращает нерелевантные темы. Для точных имён API — лучше. |
| **search_1c_help** | ✅ Работает | Находит релевантные темы (Система компоновки данных и т.п.). |
| **search_1c_help_keyword** | ✅ Отлично | По имени `ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент` находит все методы (Вывести, УстановитьДокумент и др.). |
| **search_1c_help_with_content** | ⚠️ Нерелевантно | Для «вывод СКД в табличный документ» возвращает PredictionModelResultColumns и др. |
| **get_1c_help_topic** | ✅ Работает | Возвращает полный текст темы из индекса. Контент отдельных страниц иногда минимален (только заголовок). |
| **get_1c_function_info** | ✅ Работает | Для «ПроцессорВыводаРезультатаКомпоновкиДанныхВКоллекциюЗначений» выдаёт описание, доступность и связанные темы (УстановитьОбъект, Вывести и др.). |
| **get_1c_help_related** | ⚠️ Пусто | Для конструктора ctor_Auto.md: «No related topics» — возможно, в payload нет outgoing_links. |
| **list_1c_help_titles** | ✅ Работает | Список тем с path_prefix. |
| **get_1c_help_index_status** | ✅ Работает | 53 300 тем, 426 MB, версии 8.3.27.x. |
| **save_1c_snippet** | ✅ Работает | Сниппет сохраняется в память. |
| **compare_1c_help** | ✅ Работает | Сравнение тем между версиями. |
| **trigger_reindex** | Не тестировался | Запуск фоновой индексации. |

---

## 2. Количество вызовов для получения кода

**Оптимальная цепочка (рекомендуемая в AGENTS.md):**

1. **get_1c_code_answer** (1 вызов) — после исправления даёт готовый ответ.
2. При неполноте — **get_1c_help_topic(path)** (дополнительный вызов по `path` из результата поиска).

**Альтернатива при точном имени API:**

1. **search_1c_help_keyword** (1 вызов) — быстрый поиск по имени.
2. **get_1c_help_topic(path)** (1 вызов) — полный текст.
3. При необходимости — **get_1c_function_info(name)** — для функций/методов.

**Проверка:** для запроса «вывод СКД в таблицу значений» достаточно 1–2 вызовов.

**Для запроса «создать и вывести отчет в табличный документ»** — get_1c_code_answer даёт нерелевантные результаты. **Рекомендуемая цепочка:**
1. **search_1c_help_keyword**("ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент") — 1 вызов
2. **get_1c_help_topic(path)** — 1–2 вызова по path из результата
3. (опционально) **get_1c_function_info**("ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент")

---

## 3. Покрытие и информативность

### Что есть в справке

- **ПроцессорВыводаРезультатаКомпоновкиДанныхВКоллекциюЗначений** — страницы конструктора и методов содержат минимальный текст (описание, синтаксис без примеров).
- **get_1c_function_info** даёт сводку и ссылки на связанные темы, что помогает собрать цепочку вызовов.
- **Кураторские сниппеты** (`docs/snippets/snippets.json`) содержат полный пример «Вывод СКД в таблицу значений» с ГенераторМакетаКомпоновкиДанныхДляКоллекцииЗначений и ПроцессорВывода. Эти сниппеты должны загружаться командой `load-snippets` и учитываться при `include_memory=True` в get_1c_code_answer.

### Рекомендуемый пример кода (из snippets.json)

```bsl
СхемаКомпоновки = Отчет.КомпоновщикНастроекКомпоновкиДанных.СхемаКомпоновкиДанных;
НастройкиКомпоновки = Отчет.КомпоновщикНастроекКомпоновкиДанных.НастройкиКомпоновкиДанных;

Компоновщик = Новый КомпоновщикМакетаКомпоновкиДанных;
Компоновщик.УстановитьСхему(СхемаКомпоновки);
РезультатКомпоновки = Компоновщик.Выполнить(
    НастройкиКомпоновки,
    ,
    ,
    Тип("ГенераторМакетаКомпоновкиДанныхДляКоллекцииЗначений")
);

ТаблицаЗначений = Новый ТаблицаЗначений;
ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВКоллекциюЗначений;
ПроцессорВывода.УстановитьОбъект(ТаблицаЗначений);
ПроцессорВывода.Вывести(РезультатКомпоновки.Универсальный);
```

Этот код корректен и исполняем в 1С.

### Вывод отчёта СКД в табличный документ (добавлен сниппет)

```bsl
// Отчет — объект отчёта (например, Отчеты.МойОтчет.Создать())
СхемаКомпоновки = Отчет.КомпоновщикНастроекКомпоновкиДанных.СхемаКомпоновкиДанных;
НастройкиКомпоновки = Отчет.КомпоновщикНастроекКомпоновкиДанных.НастройкиКомпоновкиДанных;

Компоновщик = Новый КомпоновщикМакетаКомпоновкиДанных;
Компоновщик.УстановитьСхему(СхемаКомпоновки);
Макет = Компоновщик.Выполнить(НастройкиКомпоновки);

ПроцессорКомпоновки = Новый ПроцессорКомпоновкиДанных;
ПроцессорКомпоновки.Инициализировать(Макет);

ТабличныйДокумент = Новый ТабличныйДокумент;
ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
ПроцессорВывода.УстановитьДокумент(ТабличныйДокумент);
ПроцессорВывода.Вывести(ПроцессорКомпоновки);

// ТабличныйДокумент — готов к показу или печати
```

---

## 4. Внесённое исправление

**Файл:** `src/onec_help/mcp_server.py`  
**Проблема:** `search_index_keyword` возвращает `score: None`. При сортировке в `_hybrid_search` использовалось выражение `-x[1][0].get("score", 0) or 0`. При наличии ключа `score` со значением `None` `get` возвращает `None`, и выражение `-None` вызывает `TypeError: bad operand type for unary -: 'NoneType'`.

**Исправление:**

```python
# Было:
keyword_first = sorted(seen.items(), key=lambda x: (0 if x[1][1] else 1, -x[1][0].get("score", 0) or 0))

# Стало:
keyword_first = sorted(
    seen.items(),
    key=lambda x: (0 if x[1][1] else 1, -(x[1][0].get("score") or 0)),
)
```

Теперь `(score or 0)` гарантирует число перед применением `-`.

---

## 5. Рекомендации

1. **Пересобрать MCP-контейнер** после исправления:  
   `docker compose build mcp && docker compose up -d mcp`

2. **Загрузить кураторские сниппеты** (если ещё не загружены):  
   `docker compose exec mcp python -m onec_help load-snippets`  
   (путь к `docs/snippets/snippets.json` по умолчанию)

3. **Рекомендуемый порядок вызовов** (согласно AGENTS.md):  
   - быстрый код → `get_1c_code_answer`  
   - при недостатке деталей → `get_1c_help_topic(path)`  
   - для точных имён API → `search_1c_help_keyword`

4. **Расширить тесты MCP** (см. `docs/test-and-lint-review.md`): добавить unit-тесты для `_hybrid_search` с `score=None` и вызовы инструментов через замоканный FastMCP.

5. **Перезагрузить сниппеты** после добавления «Вывод СКД в табличный документ» в `docs/snippets/snippets.json`:  
   `docker compose exec mcp python -m onec_help load-snippets`

# Поиск по справке 1С и MCP

## Улучшения качества поиска (2025)

### 1. Типичные промахи семантики

Семантический поиск (`get_1c_code_answer`, `search_1c_help`) иногда возвращает нерелевантные темы при описательных запросах («как вывести СКД в таблицу») или при именах API, отличающихся от справки. При низком score семантики (< 0.48) и отсутствии keyword-совпадений `get_1c_code_answer` добавляет подсказку:

> *При нерелевантных результатах попробуйте search_1c_help_keyword с точным именем API (напр. Тип.Метод).*

### 2. Расширенный keyword-поиск

`_extract_keyword_tokens` в hybrid search теперь:

- **Type.Method целиком** — при запросе «HTTPСоединение.Получить» ищется полная строка, а не отдельные токены.
- Лимит токенов увеличен с 5 до 8 для лучшего покрытия.

Синонимы API (напр. ПакетПолучения→ВыполнитьПакет) не хардкодятся в коде — см. таблицу в skill и используйте `search_1c_help_keyword` вручную при необходимости.

### 3. Skill 1c-mcp-development

Добавлена секция «Типичные промахи семантики» с таблицей частых синонимов API и порядком действий при нерелевантных результатах. См. `.cursor/skills/1c-mcp-development/SKILL.md` и `docs/cursor-examples/1c-mcp-development/SKILL.md`.

---

## Почему «Topic not found» и точные термины не находились

1. **Контент не на диске после ingest**  
   При `ingest` справка распаковывается во **временный** каталог, конвертируется в Markdown, индексируется в Qdrant, после чего временные файлы **удаляются**. MCP запускается с `HELP_PATH=/data`, но в `/data` ничего не записывается. Поэтому `get_1c_help_topic(path)` искал файл на диске и не находил его.

   **Исправление:** топик по пути теперь подгружается из **payload в Qdrant**, если файл по этому пути на диске отсутствует.

2. **Только семантический поиск**  
   Векторный поиск по эмбеддингам может «промахнуться» по точным терминам (например имена API, «интерактивный режим»), особенно если термин не в первых 8000 символах страницы (используемых для эмбеддинга).

   **Исправление:** добавлен **ключевой поиск** (`search_1c_help_keyword`) — по вхождению подстроки в заголовок и текст. Для точных имён и параметров запуска его нужно вызывать первым.

3. **get_1c_function_info**  
   Раньше использовал только семантический поиск и совпадение по заголовку. Для точных имён API теперь сначала выполняется ключевой поиск, затем при необходимости семантический.

## Оптимизация результата поиска

- Для **точных имён** (функции, параметры командной строки, имена обработок и т.д.) — используйте **search_1c_help_keyword**.
- Для **общих вопросов** («как объединить периоды», «синтаксис запроса») — **search_1c_help**.
- После поиска получайте полный текст по **path** из выдачи через **get_1c_help_topic**.
- Для просмотра списка тем (например, все параметры запуска) — **list_1c_help_titles** с `path_prefix="zif"`.

В payload индекса теперь сохраняется до 50 000 символов текста темы (ранее 12 000), чтобы длинные статьи полностью подгружались из Qdrant при отсутствии файла на диске.

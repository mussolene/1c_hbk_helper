// ============================================================================
// Пример: получение и вывод погоды на управляемой форме 1С
// API: Open-Meteo (бесплатный, без ключа) — api.open-meteo.com
// Код выполняется на сервере (HTTPСоединение.Получить доступен только на сервере)
// ============================================================================
//
// Настройка формы:
// 1. Реквизиты: ТекстПогоды (Строка), Широта (Число), Долгота (Число)
// 2. Элементы: поле "ТекстПогоды" (многострочное, ТекстПогоды),
//    при необходимости — поля Широта, Долгота (по умолчанию Москва)
// 3. Команда ПолучитьПогоду → кнопка "Получить погоду"
//
// ============================================================================

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриЧтенииНаСервере(Отказ, СтандартнаяОбработка)
	Если Не ЗначениеЗаполнено(Широта) Тогда Широта = 55.7558; КонецЕсли;
	Если Не ЗначениеЗаполнено(Долгота) Тогда Долгота = 37.6173; КонецЕсли;
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаСервере
Процедура ПолучитьПогоду(Команда)
	ТекстПогоды = ПолучитьПогодуИзAPI(Широта, Долгота);
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Функция ПолучитьПогодуИзAPI(Широта, Долгота)
	
	// Значения по умолчанию — Москва
	Если Не ЗначениеЗаполнено(Широта) Тогда
		Широта = 55.7558;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(Долгота) Тогда
		Долгота = 37.6173;
	КонецЕсли;
	
	ШиротаСтр = СтрЗаменить(Формат(Широта, "ЧДЦ=4"), ",", ".");
	ДолготаСтр = СтрЗаменить(Формат(Долгота, "ЧДЦ=4"), ",", ".");
	АдресРесурса = СтрШаблон("/v1/forecast?latitude=%1&longitude=%2&current_weather=true", ШиротаСтр, ДолготаСтр);
	
	Попытка
		Соединение = Новый HTTPСоединение("api.open-meteo.com", 443, , , , 30);
		Соединение.ЗащищенноеСоединение = Истина;
		
		Запрос = Новый HTTPЗапрос(АдресРесурса);
		Ответ = Соединение.Получить(Запрос);
		
		Если Ответ.КодСостояния <> 200 Тогда
			Возврат "Ошибка: код " + Формат(Ответ.КодСостояния, "ЧГ=");
		КонецЕсли;
		
		СтрокаJSON = Ответ.ПолучитьТелоКакСтроку("utf-8");
		Возврат РазобратьПогодуJSON(СтрокаJSON);
		
	Исключение
		Возврат "Ошибка: " + ОписаниеОшибки();
	КонецПопытки;
	
КонецФункции

&НаСервере
Функция РазобратьПогодуJSON(СтрокаJSON)
	
	ЧтениеJSON = Новый ЧтениеJSON;
	ЧтениеJSON.УстановитьСтроку(СтрокаJSON);
	
	// ПрочитатьВСоответствие = Истина — иначе вернётся Структура без метода Получить()
	Данные = ПрочитатьJSON(ЧтениеJSON, Истина);
	ЧтениеJSON.Закрыть();
	
	ТекущаяПогода = Данные.Получить("current_weather");
	Если ТекущаяПогода = Неопределено Тогда
		Возврат "Не удалось разобрать ответ API";
	КонецЕсли;
	
	Температура = ТекущаяПогода.Получить("temperature");
	СкоростьВетра = ТекущаяПогода.Получить("windspeed");
	НаправлениеВетра = ТекущаяПогода.Получить("winddirection");
	Время = ТекущаяПогода.Получить("time");
	КодПогоды = ТекущаяПогода.Получить("weathercode");
	
	ОписаниеПогоды = КодПогодыВТекст(КодПогоды);
	
	Результат = СтрШаблон(
		"Погода на %1
		|Температура: %2 °C
		|Ветер: %3 км/ч, направление %4°
		|%5",
		Время,
		Формат(Температура, "ЧДЦ=1"),
		Формат(СкоростьВетра, "ЧДЦ=1"),
		НаправлениеВетра,
		ОписаниеПогоды);
	
	Возврат Результат;
	
КонецФункции

&НаСервере
Функция КодПогодыВТекст(КодПогоды)
	// Коды погоды WMO (упрощённый набор)
	Соответствие = Новый Соответствие;
	Соответствие.Вставить(0, "Ясно");
	Соответствие.Вставить(1, "Преимущественно ясно");
	Соответствие.Вставить(2, "Переменная облачность");
	Соответствие.Вставить(3, "Пасмурно");
	Соответствие.Вставить(45, "Туман");
	Соответствие.Вставить(48, "Изморозь");
	Соответствие.Вставить(51, "Морось");
	Соответствие.Вставить(61, "Дождь");
	Соответствие.Вставить(71, "Снег");
	Соответствие.Вставить(80, "Ливень");
	Соответствие.Вставить(95, "Гроза");
	
	Текст = Соответствие.Получить(КодПогоды);
	Если Текст = Неопределено Тогда
		Текст = "Код " + Формат(КодПогоды, "ЧГ=");
	КонецЕсли;
	Возврат Текст;
	
КонецФункции

#КонецОбласти

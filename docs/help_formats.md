# Формальная спецификация форматов справки 1С

Документ задаёт входные форматы (архивы справки, HTML) и целевой формат Markdown для промышленной конвертации и индексации.

---

## 1. Файлы .hbk (архив справки)

### 1.1 Назначение

- **.hbk** — архив справки 1С:Предприятие (синтаксис, платформа, конфигурирование).
- Содержит: HTML-статьи, структуру каталогов/разделов, индексы для поиска, стили.
- Распаковка: в проекте команда `unpack` пробует по очереди несколько методов (см. 1.3). Вручную: `7z x file.hbk -o./out` или `unzip file.hbk -d ./out`. Если все методы дают ошибку — распакуйте вручную и используйте каталог с HTML.

### 1.2 Получение HTML

- Либо распаковать .hbk (команда `unpack` или вручную) и подать каталог с .html на `build-docs` / `build-index`.
- Либо использовать уже распакованную справку (каталог с .html и, при наличии, `__categories__`).

### 1.3 Методы распаковки (модуль unpack)

Команда `unpack` и ingest используют каскад fallback-методов:

| № | Метод | Назначение |
|---|-------|------------|
| 1 | **7z** (default, `-t*`, `-tcab`, `-tzip`) | Стандартные архивы; mapui/schemui иногда CAB |
| 2 | **Python zipfile** | ZIP/deflate без внешних зависимостей |
| 3 | **ZIP from offset** | .hbk с заголовком: ZIP начинается со смещения (1656, 2048, 1024, 512, 256, 4096, 8192 байт); `truncate_tail` — обрезка хвоста при «data after end» |
| 4 | **unzip** (команда) | Резервный вариант для чистого ZIP |
| 5 | **Scan local headers** | Встроенный ZIP с повреждённым/отсутствующим EOCD (schemui_ru, mapui_ru — формат FileStorage): сканирование `PK\x03\x04`, ручной разбор записей, zlib.decompress |

При ошибке всех методов: `unpack` выводит подсказку; для диагностики — **`unpack-diag <file> -o /tmp/out`**: пробует каждый метод и печатает результат (7z l -slt, returncode, извлечено/нет). Используйте при «All unpack methods failed».

### 1.4 Поведение проекта

- Конвейер (build-docs → build-index) работает с **каталогом HTML** (распакованным из .hbk или полученным иначе).

---

## 2. HTML-статьи справки (вход конвертера)

В распакованной справке встречаются **два основных варианта** разметки.

### 2.1 Схема V8SH (Syntax Helper / контекстная справка)

Классы стилей 1С для структурированных статей (функции, методы, свойства):

| Класс / элемент | Назначение |
|-----------------|------------|
| `h1.V8SH_pagetitle` | Заголовок страницы (имя функции/метода/свойства) |
| `p.V8SH_chapter` | Заголовок секции: «Описание:», «Синтаксис:», «Параметры:», «Возвращаемое значение:», «Пример:», «См. также:» |
| `div.V8SH_rubric` | Один параметр: внутри `p` — имя, `a` — тип |
| `p.V8SH_heading` | Подзаголовок (дублирование имени и т.п.) |
| Содержимое секций | Текст в соседних `p`, блок кода в `pre`, пример в `table` или `pre` |

Правила извлечения:

- **Описание** — текст после `p.V8SH_chapter` с текстом "Описание:" (следующий `p` или следующий текстовый узел).
- **Синтаксис** — содержимое следующего после заголовка "Синтаксис:" блока `pre` или текстовый узел; оборачивается в markdown-блок кода.
- **Параметры** — все последующие `div.V8SH_rubric` до следующей секции; каждый даёт строку `- **Имя** (Тип)`.
- **Возвращаемое значение** — текст после заголовка "Возвращаемое значение:".
- **Пример** — следующая после "Пример:" `table` или `pre`; в MD — блок кода.
- **См. также** — ссылки `a` после заголовка "См. также:"; в MD — маркированный список текста ссылок.

### 2.2 Схема Legacy (книжная / старый стиль)

Статьи без классов V8SH (например, «Встроенный язык», разделы платформы):

- **Заголовок страницы**: первый `h1` (любой класс или без класса).
- **Структура**: иерархия `h2`–`h6`, параграфы `p`, таблицы (например `table.SimplyTable`), списки ссылок в `a`.
- **Секции внутри одного блока**: подписи вида `<STRONG>Синтаксис:<BR></STRONG>`, `<STRONG>Описание:<BR></STRONG>` и т.д.

Правила конвертера:

- `h1` → `#`, `h2` → `##`, … `h6` → `######`.
- Таблицы → markdown-таблицы (строки/ячейки).
- Текст с `<STRONG>Секция:</STRONG>` трактуется как начало секции; содержимое до следующей такой подписи или до следующего `h*` образует тело секции.
- Ссылки `a` с `href` сохраняются как markdown-ссылки `[текст](url)`; якоря `#...` сохраняются.

### 2.3 Общие правила

- Кодировка: UTF-8.
- Неразрывные пробелы, лишние пробелы в начале/конце строк — нормализуются.
- При отсутствии распознанной структуры используется fallback: заголовок (если найден) + весь текст `body` до разумного лимита символов.

---

## 3. Целевой формат Markdown (выход)

### 3.1 Структура статьи

- Первая строка — заголовок первого уровня: `# Заголовок`.
- Далее — секции в формате `## Название секции` и, при необходимости, `###` для подсекций.
- Стандартные секции (для статей V8SH и при наличии в исходном HTML): **Описание**, **Синтаксис**, **Параметры**, **Возвращаемое значение**, **Пример**, **См. также**, **Примечание**.

### 3.2 Элементы

- Код (синтаксис, примеры): в блоках ` ``` ` (без указания языка или с меткой при необходимости).
- Параметры: маркированный список вида `- **Имя** (Тип)` или с кратким описанием.
- Ссылки: `[текст](url)`; внутренние якоря сохраняются.
- Таблицы: в формате markdown (заголовок, разделитель, строки).

### 3.3 Качество и валидация

- Каждый выходной .md должен начинаться с `# `.
- Секции не должны быть пустыми без необходимости: если контент не извлечён, секция может не выводиться.
- Конвертер должен детерминированно обрабатывать оба варианта HTML (V8SH и Legacy) и давать предсказуемую структуру MD.

---

## 4. Проверка и тесты

- В репозитории есть фикстуры: `tests/fixtures/help_sample/` (HTML в форматах V8SH и, при наличии, legacy).
- Тесты проверяют: наличие заголовка в MD, наличие ожидаемых секций для статей-функций (Описание, Синтаксис, Параметры, Пример, См. также), отсутствие пустого результата для валидного HTML.
- Добавление новых типов статей или форматов HTML должно сопровождаться обновлением этой спецификации и тестов.

---
name: 1c-mcp-development
description: Ведёт агента по разработке 1С (BSL) с MCP 1c-help и lsp-bsl-bridge. Применять при написании, рефакторинге, ревью кода 1С, модулей .bsl, при упоминании 1C, BSL, справка 1С, BSL LS.
---

# Разработка 1С с MCP

## Когда применять

Использовать этот skill при:

- Генерации кода 1С/BSL (процедуры, функции, модули форм)
- Рефакторинге существующего кода 1С
- Запуске диагностики BSL LS
- Поиске в справке 1С по API
- Работе с файлами `.bsl`, `.1c`, `Form.xml`

## Матрица выбора инструментов

| Сценарий | MCP | Инструмент | Заметки |
|----------|-----|------------|---------|
| Примеры, API | 1c-help | `get_1c_code_answer` | `code_only=True`, если нужен только код |
| Точный поиск по имени API | 1c-help | `search_1c_help_keyword` | Передавать полное имя, напр. `Тип.Метод` |
| Детали топика | 1c-help | `get_1c_help_topic` | Параметр `topic_path`, не `path` |
| Сохранить полезный код | 1c-help | `save_1c_snippet` | После рабочего примера |
| Диагностика файла | lsp-bsl-bridge | `document_diagnostics` | URI: `file:///projects/<путь>/Module.bsl` |
| Быстрые правки | lsp-bsl-bridge | `code_actions` | Ограниченная поддержка; часто — ручные правки |
| Навигация | lsp-bsl-bridge | `project_analysis`, `symbol_explore` | Перед рефакторингом |
| Переименование | lsp-bsl-bridge | `call_graph` → `prepare_rename` → `rename` | Сначала смотреть граф вызовов |
| После массовых правок | lsp-bsl-bridge | `did_change_watched_files` | Уведомить LSP об изменениях |

## Архитектурное мышление

Думать как senior-разработчик 1С: понимать влияние правок до их внесения.

- **Перед любым изменением:** вызвать `project_analysis` → `symbol_explore` → `call_graph` для понимания зависимостей и мест вызова.
- **Модульность:** использовать `#Область ПрограммныйИнтерфейс` и `#Область СлужебныеПроцедурыИФункции`; избегать монолитных процедур.
- **Контекст выполнения:** учитывать клиент/сервер, реквизиты формы, СКД vs запрос, толстый/тонкий клиент.
- **Антипаттерны:** процедуры >100 строк, магические числа, отсутствие явной обработки ошибок.
- **Перед рефакторингом:** всегда вызывать `call_graph` для оценки влияния.

## Циклические workflows

### Написание кода (цикл до чистоты)

1. Вызвать `get_1c_code_answer(query)` для примеров.
2. Если результат скудный или нерелевантный → вызвать `search_1c_help_keyword("Тип.Метод")` с полным именем или `get_1c_help_topic(topic_path)`.
3. Реализовать или адаптировать код.
4. Вызвать `document_diagnostics(uri)`.
5. **При ERROR или WARNING:** исправить → повторить п. 4. Не продолжать, пока не чисто.
6. Если результат переиспользуемый: вызвать `save_1c_snippet(code_snippet, description, title)`.
7. По желанию добавить unit-тесты 1С (xUnitFor1C) или BDD (Vanessa-Automation) для новой логики.

### Рефакторинг (цикл по файлам)

1. Сначала вызвать `call_graph` и `project_analysis` для понимания влияния.
2. Вызвать `document_diagnostics(uri)` для базового состояния.
3. Редактировать по одному файлу.
4. После каждой правки вызывать `document_diagnostics(uri)`.
5. **При ERROR:** исправить → повторить п. 4.
6. После batch правок: вызвать `did_change_watched_files` для переиндексации LSP.
7. Повторить п. 3–6 для следующего файла.

### Тестирование (Python onec_help)

При изменении Python-кода в этом проекте:

1. Редактировать код.
2. Запустить `PYTHONPATH=src python -m pytest tests -v --cov=src/onec_help --cov-report=term-missing --cov-fail-under=70`.
3. **При падении тестов или покрытии < 70%:** исправить → повторить п. 2.
4. Запустить `ruff check src tests && ruff format src tests`.

Подробнее — [reference.md](reference.md): pytest, xUnitFor1C, CoverageBSL.

## URI для document_diagnostics

При bsl-bridge в Docker (volume `.:/projects`):

```
file:///projects/src/DataProcessors/.../Forms/.../Ext/Form/Module.bsl
```

Путь на хосте `./src/...` → в контейнере `file:///projects/src/...` (volume `.:/projects`)

## Типичные промахи семантики

Семантический поиск (`get_1c_code_answer`, `search_1c_help`) иногда возвращает нерелевантные темы при:

- Описательных запросах («как вывести СКД в таблицу», «синтаксис ОбъединитьПериодов»)
- Именах API, которые в справке называются иначе
- Коротких или общих терминах («таблица», «формат»)

**Действия при нерелевантных результатах:**

1. Вызвать `search_1c_help_keyword` с **полным** именем API (`Тип.Метод`).
2. Если точное имя неизвестно — попробовать синонимы (см. ниже).
3. По результатам keyword-поиска взять `path` и вызвать `get_1c_help_topic(topic_path)` для полного текста.

**Частые синонимы API (в справке может быть другое имя):**

| Интуитивное имя | Имя в справке 1С |
|-----------------|------------------|
| `Запрос.ПакетПолучения` | `Запрос.ВыполнитьПакет` |
| `Формат` (функция) | искать `Format` или `Глобальный контекст`, категория «Формат» |
| Вывод СКД в таблицу | `ПроцессорВыводаРезультатаКомпоновкиДанныхВКоллекциюЗначений` или `...ВТабличныйДокумент` |

При низком качестве ответа `get_1c_code_answer` в выдаче может быть подсказка: *«При нерелевантных результатах попробуйте search_1c_help_keyword с точным именем API»*.

## Типичные ошибки

| Ошибка | Исправление |
|--------|-------------|
| `get_1c_help_topic(path=...)` | Параметр `path` не использовать; только `topic_path` |
| `ПрочитатьJSON` возвращает Соответствие | Добавить `ПрочитатьВСоответствие=Истина` |
| `HTTPСоединение.Получить` на клиенте | Только сервер; использовать HTTPЗапрос или RPC |
| Поиск только по `Метод` | Передавать полное `Тип.Метод` в `search_1c_help_keyword` |
| Пропуск `did_change_watched_files` | Вызывать после batch правок, чтобы LSP оставался в синхронизации |
| Продолжение при неисправленных diagnostics | Цикл: исправить → `document_diagnostics` до чистоты |

## Дополнительно

См. [reference.md](reference.md): URI, примеры вызовов, команды тестирования (pytest, xUnitFor1C, CoverageBSL).

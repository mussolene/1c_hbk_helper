# Анализ вызовов MCP 1C-help

**Дата:** 2025-02-26  
**Источники:** транскрипты агентов, [mcp-tools-test-report.md](mcp-tools-test-report.md), [snippets-analysis.md](snippets-analysis.md)

---

## 1. Что сработало хорошо

| Аспект | Описание |
|--------|----------|
| **search_1c_help_keyword** | Надёжно находит темы по точным именам API: `ПроцессорВыводаРезультатаКомпоновкиДанныхВКоллекциюЗначений`, `ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент`. Для «вывод СКД в таблицу» — оптимальный первый вызов. |
| **get_1c_help_topic(path)** | Стабильно возвращает полный текст темы по пути из результатов поиска. Работает и с диска, и из индекса. |
| **get_1c_function_info(name)** | Даёт описание, синтаксис, связанные методы. Помогает собрать цепочку вызовов (Выполнить → Инициализировать → Вывести). |
| **list_1c_help_titles, get_1c_help_index_status** | Полезны для отладки и проверки индекса (53 300+ тем). |
| **save_1c_snippet** | Работает; после добавления `title` и доработки `_format_long_summary` embedding стал осмысленнее. |
| **Кураторские сниппеты** | При `include_memory=True` `get_1c_code_answer` находит готовые примеры из `load-snippets` (snippets.json, skd_composition_result.json). |
| **Исправление score=None** | Баг `TypeError: bad operand type for unary -: 'NoneType'` в `_hybrid_search` устранён — `get_1c_code_answer` и `search_1c_help_with_content` больше не падают. |

---

## 2. Чего не хватает

| Проблема | Детали |
|----------|--------|
| **Полные примеры в справке** | Справка 1С даёт описания API, но мало цепочек вызовов (Компоновщик → Макет → Процессор → Вывести). Агент вынужден искать код в вебе или полагаться на сниппеты. |
| **Стабильность get_1c_code_answer** | Для естественного языка («создать отчет в табличный документ», «вывод СКД») часто возвращает нерелевантные темы. Семантика embedding не всегда соответствует намерению. |
| **search_1c_help_with_content** | Гибридный поиск + полный контент — удобная комбинация, но результаты для русских запросов нестабильны (PredictionModelResultColumns вместо СКД). |
| **get_1c_help_related** | Для части тем возвращает «No related topics» — возможно, в payload индекса нет `outgoing_links` или они не заполняются при парсинге. |
| **Версионирование справки** | `version` и `language` в инструментах есть, но не всегда применяются корректно при чтении из диска. |
| **Инструкция по выбору инструмента** | Агент не всегда выбирает правильную цепочку. Нет явной подсказки «для точных имён → keyword, для кода → get_1c_code_answer». |

---

## 3. Явные просадки и как их фиксить

### 3.1. get_1c_code_answer возвращает нерелевантное

**Просадка:** Запрос «вывод СКД в таблицу значений» → темы про РегистрБухгалтерии, HTMLHRElement и т.п.

**Причины:**
- Семантический поиск по справке даёт слабые совпадения для коротких/расплывчатых запросов.
- Hybrid search (semantic + keyword) не всегда достаточен без точных токенов.

**Как фиксить:**
1. **Усилить keyword-фазу** — извлекать токены типа «СКД», «компоновк», «таблиц», «ПроцессорВывод» и бустить их в hybrid.
2. **Приоритет сниппетов** — если `search_long` по памяти нашёл сниппет с высоким score, выводить его первым, до справки.
3. **Рекомендация в AGENTS.md** — явно указать: «при неудаче get_1c_code_answer вызвать search_1c_help_keyword с точным именем API».

### 3.2. search_1c_help_with_content нестабилен

**Просадка:** Для «вывод СКД в табличный документ» возвращает PredictionModelResultColumns и др.

**Причины:**
- Тот же hybrid search, что и в get_1c_code_answer; семантика доминирует и тянет нерелевантное.

**Как фиксить:**
1. Добавить **keyword fallback** — если топ-результаты semantic не содержат ключевых слов запроса, делать дополнительный keyword-поиск и мержить.
2. **Фильтр по релевантности** — отсекать результаты с score < порога перед загрузкой контента.

### 3.3. save_1c_snippet редко вызывается

**Просадка:** Агент выдаёт рабочий код, но не сохраняет его через `save_1c_snippet`, память не обогащается.

**Причины (из snippets-analysis.md):**
- Нет явной инструкции в AGENTS.md (частично добавлено).
- Фокус на ответе, а не на обогащении.
- При пустых title/query embedding слабый (уже поправлено в `_format_long_summary`).

**Как фиксить:**
1. **Жёсткое правило в AGENTS.md:** «При выдаче исполняемого кода 1С, которого нет в базовых сниппетах, ОБЯЗАТЕЛЬНО вызвать save_1c_snippet».
2. **Подсказка в описании get_1c_code_answer:** «If you use this result as final code, call save_1c_snippet to improve future answers.»

### 3.4. get_1c_help_related пусто

**Просадка:** Для конструктора ctor_Auto.md — «No related topics».

**Причины:**
- Индекс Qdrant хранит `outgoing_links` в payload; при парсинге HTML→Markdown ссылки могли не извлекаться.
- Функция `get_1c_help_related` ищет по `outgoing_links`; если поле пустое — возвращает пусто.

**Как фиксить:**
1. Проверить **html2md** и **indexer** — извлекаются ли ссылки из HTML и попадают ли в payload.
2. Добавить **fallback** — если `outgoing_links` пусто, искать семантически похожие темы по title/topic_path.

### 3.5. Дублирование вызовов

**Просадка:** Агент вызывает get_1c_code_answer, потом search_1c_help, потом get_1c_help_topic — избыточно.

**Как фиксить:**
1. **Чёткий порядок в AGENTS.md:**
   - 1-й вызов: `get_1c_code_answer` (всё в одном).
   - При недостатке: `get_1c_help_topic(path)` по path из результата.
   - Для точных имён API: сразу `search_1c_help_keyword`, потом `get_1c_help_topic`.
2. **Описание инструментов** — явно указать «Prefer X over Y when …».

---

## 4. Рекомендуемый порядок вызовов (обновлённый)

| Задача | Цепочка |
|--------|---------|
| Быстрый код по запросу | 1. `get_1c_code_answer(query)` → при неудаче: 2. `search_1c_help_keyword(точное_имя_API)` → 3. `get_1c_help_topic(path)` |
| Поиск по точному имени | 1. `search_1c_help_keyword(name)` → 2. `get_1c_help_topic(path)` или `get_1c_function_info(name)` |
| Сравнение версий | `compare_1c_help(topic, version_left, version_right)` |
| Сохранение кода | После выдачи рабочего кода: `save_1c_snippet(code, description, title)` |

---

## 5. Изменения для внедрения

| Файл/область | Действие |
|--------------|----------|
| **AGENTS.md** | Добавить правило: «При неудаче get_1c_code_answer вызывать search_1c_help_keyword с точным именем API»; усилить правило save_1c_snippet. |
| **mcp_server.py** | Усилить keyword-фазу в hybrid search; приоритет сниппетов при высоком score; fallback в get_1c_help_related. |
| **snippets/** | Добавлен `skd_composition_result.json` — 8 вариантов получения результата СКД программно. Загружать через `make load-snippets`. |
| **indexer/html2md** | Проверить извлечение `outgoing_links` для get_1c_help_related. |
| **Описания инструментов** | Добавить в get_1c_code_answer: «If result is usable code, call save_1c_snippet.» |

---

## 6. Метрики для мониторинга

- Количество вызовов на один успешный ответ (цель: 1–2).
- Доля запросов, где get_1c_code_answer дал релевантный результат с первого раза.
- Частота вызовов save_1c_snippet после выдачи кода.
- Доля «No related topics» в get_1c_help_related.

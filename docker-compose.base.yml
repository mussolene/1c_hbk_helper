# Base: Qdrant + mcp. Include from docker-compose.yml (split) or docker-compose.full.yml.
# BSL bridge — отдельно: make bsl-start (docker-compose.bsl.yml).
# compose-spec: https://docs.docker.com/compose/compose-file/
# Данные в ./data/ (в .gitignore) — backup: копируйте папку data/.
# Переменные окружения: .env в корне проекта (скопируйте env.example в .env).

services:
  qdrant:
    image: qdrant/qdrant:v1.12.0
    ports:
      - "${QDRANT_PORT:-6333}:6333"
    volumes:
      - ./data/qdrant:/qdrant/storage
    healthcheck:
      test: ["CMD", "bash", "-c", "exec 3<>/dev/tcp/127.0.0.1/6333 && echo -e 'GET /readyz HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && grep -q 'HTTP/1.1 200' <&3"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  mcp:
    build:
      context: .
      args:
        EMBEDDING_BACKEND: "${EMBEDDING_BACKEND:-openai_api}"
    ports:
      - "${MCP_PORT:-8050}:8050"
    environment:
      MCP_MODE: ${MCP_MODE:-full}
      QDRANT_HOST: ${QDRANT_HOST:-qdrant}
      QDRANT_PORT: ${QDRANT_PORT:-6333}
      QDRANT_COLLECTION: ${QDRANT_COLLECTION:-onec_help}
      QDRANT_STORAGE_PATH: /qdrant_storage
      MCP_TRANSPORT: ${MCP_TRANSPORT:-streamable-http}
      MCP_HOST: ${MCP_HOST:-0.0.0.0}
      MCP_PORT: "8050"
      MCP_PATH: ${MCP_PATH:-/mcp}
      HELP_SOURCE_BASE: ${HELP_SOURCE_BASE:-/opt/1cv8}
      HELP_LANGUAGES: ${HELP_LANGUAGES:-ru}
      HELP_INGEST_TEMP: ${HELP_INGEST_TEMP:-/tmp/help_ingest}
      INGEST_CACHE_FILE: ${INGEST_CACHE_FILE:-/app/var/ingest_cache/ingest_cache.db}
      INGEST_FAILED_LOG: ${INGEST_FAILED_LOG:-/var/log/ingest_failed.log}
      EMBEDDING_BACKEND: ${EMBEDDING_BACKEND:-openai_api}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-text-text-embedding-mxbai-embed-large-v1}
      EMBEDDING_API_URL: ${EMBEDDING_API_URL:-http://host.docker.internal:1234/v1}
      EMBEDDING_API_KEY: ${EMBEDDING_API_KEY:-}
      EMBEDDING_DIMENSION: ${EMBEDDING_DIMENSION:-}
      EMBEDDING_BATCH_SIZE: ${EMBEDDING_BATCH_SIZE:-64}
      EMBEDDING_WORKERS: ${EMBEDDING_WORKERS:-4}
      EMBEDDING_FORCE_BATCH: ${EMBEDDING_FORCE_BATCH:-0}
      EMBEDDING_TIMEOUT: ${EMBEDDING_TIMEOUT:-60}
      WATCHDOG_ENABLED: ${WATCHDOG_ENABLED:-0}
      WATCHDOG_POLL_INTERVAL: ${WATCHDOG_POLL_INTERVAL:-600}
      WATCHDOG_PENDING_INTERVAL: ${WATCHDOG_PENDING_INTERVAL:-600}
      SNIPPETS_DIR: ${SNIPPETS_DIR:-/data/snippets}
      SAVE_SNIPPET_TO_FILES: ${SAVE_SNIPPET_TO_FILES:-1}
      MEMORY_ENABLED: ${MEMORY_ENABLED:-1}
      MEMORY_BASE_PATH: ${MEMORY_BASE_PATH:-}
      STANDARDS_REPOS: ${STANDARDS_REPOS:-1C-Company/v8-code-style:master,zeegin/v8std:main}
      STANDARDS_SUBPATH: ${STANDARDS_SUBPATH:-docs}
      STANDARDS_DIR: ${STANDARDS_DIR:-}
    volumes:
      - /opt/1cv8:/opt/1cv8:ro
      - ./data/qdrant:/qdrant_storage:ro
      - ./data/ingest_cache:/app/var/ingest_cache
      - ./data/snippets:/data/snippets
      - ./data/standards:/data/standards
      - ./data/backup:/data/backup
    command: ["python", "-m", "onec_help", "mcp", "/data", "--transport", "streamable-http", "--host", "0.0.0.0", "--port", "8050"]
    depends_on:
      qdrant:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import socket; s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1', 8050)); s.close()\" || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

# compose-spec: https://docs.docker.com/compose/compose-file/
# 1C Help: Qdrant + MCP. Один контейнер mcp: MCP-сервер (порт 5050) + cron для индексации из /opt/1cv8.
# На Mac: Docker Desktop → Settings → Resources → File sharing — добавьте /opt (или /opt/1cv8).
# При старте контейнера (если есть /opt/1cv8) ingest запускается в фоне; логи: docker compose exec mcp tail -f /app/var/log/ingest.log
# Индексация вручную: docker compose exec mcp python -m onec_help ingest
#
# База Qdrant: ./data/qdrant (в проекте, в .gitignore) — при перезапуске не теряется.
#
# Сниппеты: смонтируйте папку со сниппетами (*.bsl, *.1c, *.md, snippets.json), read-only.
#   volumes: ./snippets:/data/snippets:ro  и SNIPPETS_DIR=/data/snippets. При старте — load-snippets.
#
# Только распаковка .hbk (тот же образ mcp, другая команда):
#   docker compose run --rm -v /path/to/1cv8:/input:ro -v $(pwd)/unpacked:/output mcp python -m onec_help unpack-dir /input -o /output -l ru
#
# Переменные окружения берутся из .env в корне проекта (скопируйте env.example в .env).
# Значения ниже — подстановка ${VAR:-default}; при отсутствии .env используются defaults.

services:
  qdrant:
    image: qdrant/qdrant:v1.12.0
    ports:
      - "${QDRANT_PORT:-6333}:6333"
    volumes:
      # База Qdrant в папке проекта — не теряется при перезапуске и видна в репозитории
      - ./data/qdrant:/qdrant/storage
    healthcheck:
      test: ["CMD", "bash", "-c", "exec 3<>/dev/tcp/127.0.0.1/6333 && echo -e 'GET /readyz HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && grep -q 'HTTP/1.1 200' <&3"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  mcp:
    build:
      context: .
      args:
        # От этого значения зависит, ставится ли [embed] (sentence-transformers). Должно совпадать с runtime.
        EMBEDDING_BACKEND: "${EMBEDDING_BACKEND:-openai_api}"
    ports:
      - "${MCP_PORT:-5050}:5050"
    environment:
      QDRANT_HOST: ${QDRANT_HOST:-qdrant}
      QDRANT_PORT: ${QDRANT_PORT:-6333}
      QDRANT_COLLECTION: ${QDRANT_COLLECTION:-onec_help}
      # Путь к хранилищу Qdrant внутри контейнера (смонтирован ниже) — для вывода размера БД в index-status
      QDRANT_STORAGE_PATH: /qdrant_storage
      MCP_TRANSPORT: ${MCP_TRANSPORT:-streamable-http}
      MCP_HOST: ${MCP_HOST:-0.0.0.0}
      MCP_PORT: "5050"
      MCP_PATH: ${MCP_PATH:-/mcp}
      HELP_SOURCE_BASE: ${HELP_SOURCE_BASE:-/opt/1cv8}
      HELP_LANGUAGES: ${HELP_LANGUAGES:-ru}
      HELP_INGEST_TEMP: ${HELP_INGEST_TEMP:-/tmp/help_ingest}
      INGEST_CACHE_FILE: ${INGEST_CACHE_FILE:-/qdrant_storage/ingest_cache.db}
      INGEST_FAILED_LOG: ${INGEST_FAILED_LOG:-/var/log/ingest_failed.log}
      # Эмбеддинги: openai_api (по умолчанию) или local; при openai_api задать EMBEDDING_API_URL
      EMBEDDING_BACKEND: ${EMBEDDING_BACKEND:-openai_api}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-text-text-embedding-mxbai-embed-large-v1}
      EMBEDDING_API_URL: ${EMBEDDING_API_URL:-http://host.docker.internal:1234/v1}
      EMBEDDING_API_KEY: ${EMBEDDING_API_KEY:-}
      EMBEDDING_DIMENSION: ${EMBEDDING_DIMENSION:-}
      EMBEDDING_BATCH_SIZE: ${EMBEDDING_BATCH_SIZE:-64}
      EMBEDDING_WORKERS: ${EMBEDDING_WORKERS:-4}
      EMBEDDING_FORCE_BATCH: ${EMBEDDING_FORCE_BATCH:-0}
      EMBEDDING_TIMEOUT: ${EMBEDDING_TIMEOUT:-60}
      WATCHDOG_ENABLED: ${WATCHDOG_ENABLED:-0}
      WATCHDOG_POLL_INTERVAL: ${WATCHDOG_POLL_INTERVAL:-600}
      WATCHDOG_PENDING_INTERVAL: ${WATCHDOG_PENDING_INTERVAL:-600}
      # Каталог сниппетов (*.bsl, *.1c, *.md, snippets.json). При старте — load-snippets
      SNIPPETS_DIR: ${SNIPPETS_DIR:-/data/snippets}
    volumes:
      - /opt/1cv8:/opt/1cv8:ro
      # Доступ к хранилищу Qdrant только для чтения — index-status показывает размер БД на диске
      - ./data/qdrant:/qdrant_storage:ro
      # Сниппеты — только чтение. Хост: ./snippets или SNIPPETS_HOST_PATH
      - ${SNIPPETS_HOST_PATH:-./snippets}:/data/snippets:ro
    command: ["python", "-m", "onec_help", "mcp", "/data", "--transport", "streamable-http", "--host", "0.0.0.0", "--port", "5050"]
    depends_on:
      qdrant:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import socket; s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1', 5050)); s.close()\" || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
